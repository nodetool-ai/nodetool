<!DOCTYPE html>
<html>

<head>
    <title>Nodetool</title>
    <style>
        body, html {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background-color: #000;
            font-family: Arial, sans-serif;
        }

        #content {
            flex: 1;
            border: none;
        }

        #log-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #000;
            transition: height 0.3s ease-out;
            height: 30px;
            overflow: hidden;
            z-index: 1000;
        }

        #log-container.expanded {
            height: 200px;
        }

        #log-toggle {
            width: 100%;
            height: 30px;
            background-color: #111;
            color: #ffffff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        #log-toggle:hover {
            background-color: #555555;
        }
        
        #log {
            height: 170px;
            overflow-y: auto;
            color: #00ff00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 10px;
            background-color: #000000;
        }

        .log-line {
            overflow: hidden;
            white-space: nowrap;
            margin: 0;
            line-height: 1.2;
        }

        .log-line.last::after {
            content: 'â–ˆ';
            animation: blink 0.7s infinite;
        }

        #boot-message {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #000;
            color: #ffffff;
            font-size: 36px;
            font-family: 'Arial Black', sans-serif;
            text-align: center;
            overflow: hidden;
            z-index: 1000;
        }

        .boot-text {
            position: relative;
            animation: zoomInOut 4s infinite, glowPulse 2s infinite;
        }

        .boot-text::before,
        .boot-text::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 100vw;
            height: 2px;
            background: linear-gradient(to right, transparent, #4CAF50, transparent);
            transform: translateY(-50%);
            animation: lineExpand 2s ease-in-out infinite;
        }

        .boot-text::before {
            right: 100%;
            margin-right: 20px;
        }

        .boot-text::after {
            left: 100%;
            margin-left: 20px;
        }

        @keyframes zoomInOut {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        @keyframes glowPulse {
            0%, 100% { text-shadow: 0 0 5px #4CAF50, 0 0 10px #4CAF50, 0 0 15px #4CAF50; }
            50% { text-shadow: 0 0 10px #4CAF50, 0 0 20px #4CAF50, 0 0 30px #4CAF50; }
        }

        @keyframes lineExpand {
            0%, 100% { width: 0; opacity: 0; }
            50% { width: 100vw; opacity: 1; }
        }
        
        @keyframes blink {
            0%, 100% { opacity: 0; }
            50% { opacity: 1; }
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }
    </style>
</head>

<body>
    <div id="boot-message">
        <div class="boot-text"></div>
    </div>
    <iframe id="content"></iframe>
    <div id="log-container" class="expanded">
        <button id="log-toggle" style="display: none;">Hide Log</button>
        <div id="log"></div>
    </div>

    <script>
        // Remove the require('electron') line, we'll use the exposed api instead
        // const { api } = window;
        const contentElement = document.getElementById('content');
        const logElement = document.getElementById('log');
        const bootMessage = document.getElementById('boot-message');
        const logContainer = document.getElementById('log-container');
        const logToggle = document.getElementById('log-toggle');

        function createMatrixLogger(logElement) {
            let lastLogLine = null;
            let typingTimeout = null;

            function finishTyping(logLine) {
                logLine.style.width = '100%';
                logLine.style.animation = 'none';
                logLine.classList.remove('last');
            }

            function log(message) {
                if (lastLogLine) {
                    clearTimeout(typingTimeout);
                    finishTyping(lastLogLine);
                }

                const logLine = document.createElement('p');
                logLine.className = 'log-line last';
                logLine.textContent = message;
                logElement.appendChild(logLine);
                logElement.scrollTop = logElement.scrollHeight;

                // Animate the new log line
                logLine.style.width = '0';
                const duration = Math.min(message.length * 2, 500); // Cap at 500ms
                logLine.style.animation = `typing ${duration}ms steps(${message.length}, end)`;
                
                lastLogLine = logLine;
                typingTimeout = setTimeout(() => finishTyping(logLine), duration);
            }

            return { log };
        }
        function toggleLog() {
            logContainer.classList.toggle('expanded');
            logToggle.textContent = logContainer.classList.contains('expanded') ? 'Hide Log' : 'Show Log';
        }
        
        const matrixLogger = createMatrixLogger(logElement);

        function loadContentWithNoCaching() {
            const timestamp = new Date().getTime();
            contentElement.src = `http://localhost:8000?nocache=${timestamp}`;
        }

        function initializeApp() {
            api.getServerState().then(({ isStarted, bootMsg, logs }) => {
                console.log("Server state:", { isStarted, bootMsg, logs });
                if (isStarted) {
                    loadContentWithNoCaching();
                    bootMessage.style.display = 'none';
                    logToggle.style.display = 'block';
                } else {
                    const bootTextElement = document.querySelector('.boot-text');
                    bootTextElement.textContent = bootMsg;
                }

                logs.forEach(log => matrixLogger.log(log));
            });
        }

        api.onServerStarted(() => {
            loadContentWithNoCaching();
            bootMessage.style.display = 'none';
            logContainer.style.display = 'none';
            logToggle.style.display = 'block';
        });

        api.onBootMessage((message) => {
            const bootTextElement = document.querySelector('.boot-text');
            bootTextElement.textContent = message;
        });

        api.onServerLog((message) => {
            matrixLogger.log(message);
        });

        logToggle.addEventListener('click', toggleLog);

        // Initialize the app when the page loads
        initializeApp();
    </script>
</body>

</html>