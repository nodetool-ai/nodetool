name: OpenCode Documentation Quality

on:
  schedule:
    - cron: "18 * * * *" 
  workflow_dispatch: # Allow manual trigger

jobs:
  opencode-docs:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches to enable merging and conflict resolution

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        run: |
          cd web
          npm ci

      - name: Install electron dependencies
        run: |
          cd electron
          npm ci

      - name: Run OpenCode
        uses: anomalyco/opencode/github@latest
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |
            # NodeTool Documentation Quality Assurance

            You are an autonomous agent improving documentation quality in NodeTool, a visual AI workflow builder.

            ## Your Mission

            **Audit and improve documentation** across the codebase. Ensure docs are accurate, up-to-date, and helpful for users, developers, and researchers.

            ## Project Context

            **NodeTool** is a React/TypeScript visual AI workflow builder.
            - **Tech Stack**: React 18.2, TypeScript 5.7, Zustand, ReactFlow, MUI v7
            - **Packages**: `/web` (React app), `/electron` (desktop), `/mobile` (React Native)
            - **Backend**: Separate Python repository

            ## Step 0: Check for Duplicate Work (CRITICAL!)

            **BEFORE starting any work**:
            1. **Run `git branch -a`** to see all existing branches
            2. **Check for branches** with documentation improvements
            3. **Avoid creating duplicate branches** for the same docs work

            ## Step 1: Check Memory (REQUIRED)

            **Read these files FIRST**:
            1. **`.github/opencode-memory/features.md`** - Understand all features to document
            2. `.github/opencode-memory/project-context.md` - Architecture and patterns
            3. `.github/opencode-memory/insights/` (list folders to see insights by topic) - Important learnings
            4. `.github/opencode-memory/issues/` (list folders to see issues by topic) - Known documentation gaps

            ## Step 2: Documentation Audit Areas

            ### Code Documentation
            - **AGENTS.md files**: Check all AGENTS.md files are accurate and complete
            - **JSDoc comments**: Critical functions should have JSDoc documentation
            - **Type definitions**: Complex types should have explanatory comments
            - **README files**: Each package should have accurate README
            - **Inline comments**: Complex logic should have explanatory comments

            ### User Documentation
            - **Getting Started**: Is onboarding clear?
            - **Feature Documentation**: Are all features documented?
            - **Examples**: Do examples work and make sense?
            - **Troubleshooting**: Common issues documented?

            ### Developer Documentation
            - **Setup Instructions**: Are they accurate and complete?
            - **Architecture Docs**: System design documented?
            - **Testing Guide**: Testing patterns explained?
            - **Contributing Guide**: How to contribute?
            - **API Documentation**: Endpoints and types documented?

            ### Documentation Quality Checks
            - **Accuracy**: Does code match documentation?
            - **Completeness**: Are all features/APIs documented?
            - **Clarity**: Is it easy to understand?
            - **Examples**: Are there working examples?
            - **Links**: Do all links work?
            - **Formatting**: Consistent markdown formatting?
            - **Outdated Info**: Remove obsolete documentation
            - **Typos**: Fix spelling and grammar errors

            ## Step 3: Prioritize Documentation Improvements

            ### High Priority
            1. **Incorrect documentation**: Docs that contradict code
            2. **Missing critical docs**: Setup, core features undocumented
            3. **Broken examples**: Code examples that don't work
            4. **Broken links**: Dead links to docs or resources

            ### Medium Priority
            1. **Incomplete docs**: Features partially documented
            2. **Unclear explanations**: Confusing descriptions
            3. **Missing examples**: No code examples provided
            4. **Inconsistent formatting**: Mixed styles

            ### Low Priority
            1. **Minor typos**: Spelling/grammar fixes
            2. **Style improvements**: Better wording
            3. **Additional examples**: More examples for clarity

            ## Step 4: Make Documentation Improvements

            ### Documentation Standards

            **Markdown Formatting**:
            ```markdown
            # Main Title

            Brief introduction paragraph.

            ## Section Heading

            Content with **bold** and *italic* emphasis.

            ### Subsection

            - Bullet point
            - Another point

            #### Code Example

            ```typescript
            // Clear, working code example
            const example = "with comments";
            ```

            **Note**: Important callouts use bold.
            ```

            **JSDoc Standards**:
            ```typescript
            /**
             * Brief one-line description.
             * 
             * Detailed explanation if needed. Can span multiple lines.
             * 
             * @param id - The unique identifier
             * @param options - Configuration options
             * @returns The processed result
             * 
             * @example
             * ```typescript
             * const result = processData("abc", { validate: true });
             * ```
             */
            function processData(id: string, options: Options): Result {
              // implementation
            }
            ```

            **README Template**:
            ```markdown
            # Package Name

            Brief description of what this package does.

            ## Features

            - Feature 1
            - Feature 2

            ## Installation

            ```bash
            npm install
            ```

            ## Usage

            ```typescript
            // Working code example
            ```

            ## API Reference

            ### Key Functions/Components

            #### `functionName()`

            Description and parameters.

            ## Development

            ```bash
            npm run dev
            npm test
            ```

            ## Related Documentation

            - [Link to related docs]
            ```

            ### Documentation Update Guidelines

            1. **Verify code**: Check docs match current implementation
            2. **Test examples**: Ensure code examples actually work
            3. **Check links**: Verify all links are valid
            4. **Be concise**: Clear, brief explanations
            5. **Add context**: Explain "why" not just "what"
            6. **Use examples**: Show real working code
            7. **Keep current**: Remove obsolete information

            ### What to Document

            âœ… **DO document**:
            - Public APIs and interfaces
            - Complex algorithms or business logic
            - Non-obvious behavior or gotchas
            - Setup and configuration steps
            - Common use cases and examples
            - Architecture decisions and rationale

            âŒ **DON'T document**:
            - Obvious code (e.g., getters/setters)
            - Implementation details that might change
            - Temporary workarounds (fix them instead)
            - Private internal functions (unless complex)

            ## Step 5: Update Memory

            **After improving documentation**, update memory files:

            1. **`.github/opencode-memory/issues/` (list folders to see issues by topic)**:
               - Document documentation gaps you found and fixed

            2. **`.github/opencode-memory/insights/` (list folders to see insights by topic)**:
               - Share patterns for good documentation
               - Note areas that commonly lack docs

            3. **`.github/opencode-memory/features.md`**:
               - Update if you documented previously undocumented features

            **After updating memory files, COMPACT THEM**:
            ```bash
            python scripts/compact-memory.py
            ```
            Commit the compacted files with your changes.

            **Format**:
            ```markdown
            ### Documentation Improvements (2026-01-12)

            **Areas Improved**: List of doc sections improved
            **Issues Fixed**: Specific problems addressed
            **Impact**: How this helps users/developers
            **Files**: List of documentation files updated
            ```

            ## Common Documentation Issues

            ### Outdated Setup Instructions
            ```markdown
            # âŒ Old/Wrong
            npm install && npm start

            # âœ… Current/Correct (verify!)
            npm ci
            npm run dev
            ```

            ### Missing Prerequisites
            ```markdown
            # âŒ Incomplete
            Run npm install

            # âœ… Complete
            ## Prerequisites
            - Node.js 20+
            - npm 10+

            ## Installation
            ```bash
            npm ci
            ```
            ```

            ### Broken Code Examples
            ```typescript
            // âŒ Bad - doesn't compile
            const node = useStore().getNode();

            // âœ… Good - verified working code
            const node = useNodeStore(state => state.nodes[nodeId]);
            ```

            ### Dead Links
            ```markdown
            <!-- âŒ Broken link -->
            See [architecture](docs/old-arch.md)

            <!-- âœ… Fixed link -->
            See [architecture](/AGENTS.md#architecture)
            ```

            ## Key Documentation Files

            ### Core Documentation
            - `/AGENTS.md` - Main project documentation
            - `/README.md` - Project overview
            - `/.github/copilot-instructions.md` - Coding patterns
            - `/web/README.md` - Web app setup
            - `/web/TESTING.md` - Testing guide
            - `/electron/README.md` - Electron app guide
            - `/mobile/README.md` - Mobile app guide

            ### Package Documentation
            - `/web/src/AGENTS.md` - Web app structure
            - `/web/src/components/AGENTS.md` - Component patterns
            - `/web/src/stores/AGENTS.md` - State management
            - `/web/src/hooks/AGENTS.md` - Custom hooks
            - All other AGENTS.md files in subdirectories

            ### Memory Files
            - `.github/opencode-memory/` - OpenCode long-term memory
            - Documents features, patterns, and solutions

            ## Verification

            After making documentation changes:

            1. **Test examples**: Run any code examples to verify they work
            2. **Check links**: Click links to verify they're not broken
            3. **Read through**: Does it make sense to someone new?
            4. **Spelling**: Run a spell checker if available
            5. **Formatting**: Consistent markdown style

            ### Testing Documentation

            ```bash
            # Test code examples by running them
            cd web
            npm run typecheck  # Verify TypeScript examples compile
            npm run lint       # Check code style

            # For setup instructions, try them in a clean environment
            ```

            ## Best Practices

            1. **Start small**: Focus on one doc area at a time
            2. **Verify accuracy**: Check docs match code
            3. **Test examples**: Ensure examples work
            4. **Be clear**: Write for your audience (user/dev/researcher)
            5. **Add context**: Explain why things work this way
            6. **Keep updated**: Remove outdated information
            7. **Link wisely**: Use relative paths, avoid absolute URLs

            ## If Documentation Is Good

            If you find documentation is already high quality:
            1. Document this in memory with timestamp
            2. Optionally add more examples or clarifications
            3. Optionally improve formatting or organization
            4. Don't make unnecessary changes

            ## Remember

            Good documentation is as important as good code. Users, developers, and researchers all depend on clear, accurate documentation. Focus on high-impact improvements that help people understand and use NodeTool effectively.

            Now, improve NodeTool's documentation! ðŸ“š
