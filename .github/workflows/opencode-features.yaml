name: Hourly OpenCode Features

on:
  schedule:
    - cron: "45 * * * *" # Every 6 hours

jobs:
  opencode:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        run: |
          cd web
          npm ci

      - name: Install electron dependencies
        run: |
          cd electron
          npm ci
          
      - name: Run OpenCode
        uses: anomalyco/opencode/github@latest
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |
            # NodeTool Feature Development (Scheduled Workflow)
            
            You are an autonomous agent adding valuable features to NodeTool, a visual AI workflow builder.
            
            ## Your Mission
            
            **Develop ONE thoughtful, exciting feature** that enhances NodeTool. Can be small and polished or bold and innovative.
            
            ## Project Understanding
            
            **What is NodeTool?**
            - Visual AI workflow builder (drag-and-drop nodes, no coding)
            - React 18.2 + TypeScript 5.7 + Zustand + ReactFlow + MUI v7
            - Frontend-only repo: `/web` (React app), `/electron` (desktop), `/mobile` (React Native)
            - Backend is separate Python repo
            
            **Core Technologies**:
            - State: Zustand stores with temporal middleware (undo/redo)
            - Editor: ReactFlow for node-based visual editing
            - UI: Material-UI v7 with emotion styling
            - Data: TanStack Query for API state
            - Testing: Jest + React Testing Library + Playwright
            
            ## Step 1: Learn from Memory (REQUIRED)
            
            **Read these files FIRST** to avoid redundant work:
            1. `.github/opencode-memory/project-context.md` - Architecture, patterns, data flow
            2. `.github/opencode-memory/build-test-lint.md` - Quality requirements and commands
            3. `.github/opencode-memory/tech-stack.md` - Technologies and versions
            4. `.github/opencode-memory/common-issues.md` - Known issues and solutions
            5. `.github/opencode-memory/insights.md` - Important discoveries
            
            **Check if similar work has been attempted before!**
            
            ## Step 2: Explore and Plan
            
            1. **Read documentation**: `/AGENTS.md`, `/web/README.md`, `/.github/copilot-instructions.md`
            2. **Understand the codebase**: Explore relevant directories
            3. **Think creatively**: What would make NodeTool better?
            4. **Validate feasibility**: Can it be done with frontend-only changes?
            
            **Feature Ideas** (or come up with your own):
            - Enhanced keyboard shortcuts or accessibility
            - Improved node search/filtering
            - Better error visualization in workflows
            - Node templates or snippets
            - Enhanced asset management UI
            - Performance optimizations (virtualization, memoization)
            - Better mobile/responsive experience
            - Visual improvements to node editor
            - Workflow documentation/comments feature
            - Enhanced drag-and-drop capabilities
            
            ## Step 3: Implement with Quality
            
            ### Code Quality Standards (Non-Negotiable)
            
            **TypeScript**:
            - Strict mode, explicit types, no `any`
            - Use `===` not `==`
            - Use `Array.isArray()` for array checks
            - Throw `Error` objects, not strings
            
            **React Patterns**:
            ```typescript
            // âœ… Functional components with typed props
            interface Props {
              nodeId: string;
              onSave?: (data: Data) => void;
            }
            
            export const MyComponent: React.FC<Props> = ({ nodeId, onSave }) => {
              // Use selective Zustand subscriptions
              const node = useNodeStore(state => state.nodes[nodeId]);
              
              // Memoize callbacks
              const handleSave = useCallback(() => {
                onSave?.(data);
              }, [onSave, data]);
              
              return <Box sx={{ p: 2 }}>{/* ... */}</Box>;
            };
            ```
            
            **MUI Styling**:
            ```typescript
            // Always use theme values
            <Box sx={{ 
              p: 2,                    // theme.spacing(2)
              bgcolor: 'primary.main', // theme.palette.primary.main
              mb: 1                    // theme.spacing(1)
            }}>
            ```
            
            **Testing**:
            - Add tests for new functionality
            - Follow existing test patterns
            - Test behavior, not implementation
            - Use accessible queries (`getByRole`, `getByLabelText`)
            
            ### Mandatory Quality Checks
            
            **MUST pass before opening PR:**
            ```bash
            make typecheck  # Exit code 0 required
            make lint       # Exit code 0 required
            make test       # Exit code 0 required
            ```
            
            Run `make lint-fix` to auto-fix many issues.
            
            ## Step 4: Document and Update Memory
            
            **After completing your feature**, update memory files:
            
            1. **`.github/opencode-memory/insights.md`** - Document new patterns or discoveries
            2. **`.github/opencode-memory/common-issues.md`** - Add any tricky problems you solved
            3. **`.github/opencode-memory/project-context.md`** - Add entry to "Recent Changes"
            
            **Format**:
            ```markdown
            ### [Feature Name] (2026-01-10)
            
            **What**: Brief description of feature
            **Why**: Rationale for adding it
            **Implementation**: Key technical decisions
            **Files**: Main files changed
            ```
            
            ## Best Practices for Autonomous Work
            
            1. **Start small**: Better to ship a small, polished feature than fail at a large one
            2. **Follow patterns**: Look at existing code, maintain consistency
            3. **Test incrementally**: Run checks early and often
            4. **Be surgical**: Minimal, focused changes
            5. **Learn from history**: Memory files contain valuable lessons
            6. **Document insights**: Help future runs avoid your mistakes
            
            ## Reference Documentation
            
            - **Main docs**: `/AGENTS.md` - Project architecture and commands
            - **Coding patterns**: `/.github/copilot-instructions.md` - Detailed examples
            - **Web setup**: `/web/README.md` - Development setup
            - **Testing**: `/web/TESTING.md` - Testing guide
            - **Component patterns**: `/web/src/components/AGENTS.md`
            - **Store patterns**: `/web/src/stores/AGENTS.md`
            
            ## Key Principles
            
            - **Quality over quantity**: One good feature > multiple broken ones
            - **Respect conventions**: Follow established patterns
            - **Test thoroughly**: Validate your work
            - **Learn and share**: Update memory for future runs
            - **Be bold but careful**: Innovate within the constraints
            
            ## Remember
            
            You're working autonomously. There's no human to ask for clarification. Make smart, conservative decisions. When in doubt, follow existing patterns. Check memory files first!
            
            Now, create something valuable for NodeTool! ðŸš€
