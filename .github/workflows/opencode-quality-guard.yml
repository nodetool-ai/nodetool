name: OpenCode Quality Guard

on:
  workflow_call:
    inputs:
      check-before:
        description: 'Whether to check quality before running OpenCode agent'
        required: false
        type: boolean
        default: true
      check-after:
        description: 'Whether to check quality after OpenCode agent completes'
        required: false
        type: boolean
        default: true
      auto-fix:
        description: 'Whether to auto-fix lint issues after agent runs'
        required: false
        type: boolean
        default: true
      fail-on-errors:
        description: 'Whether to fail workflow if quality checks fail'
        required: false
        type: boolean
        default: true

jobs:
  pre-check:
    name: Pre-Flight Quality Check
    if: ${{ inputs.check-before }}
    runs-on: ubuntu-latest
    outputs:
      should-continue: ${{ steps.decision.outputs.should-continue }}
      has-errors: ${{ steps.check.outputs.has-errors }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          cd web && npm ci
          cd ../electron && npm ci
          cd ../mobile && npm ci

      - name: Run quality checks
        id: check
        continue-on-error: true
        run: |
          echo "## Pre-Flight Quality Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TYPECHECK_RESULT=0
          LINT_RESULT=0
          TEST_RESULT=0
          
          echo "Running TypeScript type check..." >> $GITHUB_STEP_SUMMARY
          if make typecheck 2>&1 | tee typecheck.log; then
            echo "✅ TypeScript: Passed" >> $GITHUB_STEP_SUMMARY
          else
            TYPECHECK_RESULT=1
            echo "❌ TypeScript: Failed" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>TypeScript Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 typecheck.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running ESLint..." >> $GITHUB_STEP_SUMMARY
          if make lint 2>&1 | tee lint.log; then
            echo "✅ ESLint: Passed" >> $GITHUB_STEP_SUMMARY
          else
            LINT_RESULT=1
            echo "⚠️ ESLint: Failed (can be auto-fixed)" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Lint Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 lint.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running tests..." >> $GITHUB_STEP_SUMMARY
          if make test 2>&1 | tee test.log; then
            echo "✅ Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            TEST_RESULT=1
            echo "❌ Tests: Failed" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test Failures</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $TYPECHECK_RESULT -ne 0 ] || [ $LINT_RESULT -ne 0 ] || [ $TEST_RESULT -ne 0 ]; then
            echo "has-errors=true" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "⚠️ **Pre-existing quality issues detected!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "OpenCode agents should focus on:" >> $GITHUB_STEP_SUMMARY
            echo "1. Not introducing NEW errors" >> $GITHUB_STEP_SUMMARY
            echo "2. Potentially fixing EXISTING errors if relevant to their task" >> $GITHUB_STEP_SUMMARY
            echo "3. Running \`make lint-fix\` to auto-fix lint issues" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "has-errors=false" >> $GITHUB_OUTPUT
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All quality checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

      - name: Decision on continuing
        id: decision
        if: always()
        run: |
          if [ "${{ steps.check.outputs.has-errors }}" == "true" ]; then
            echo "should-continue=false" >> $GITHUB_OUTPUT
            echo "⚠️ Quality checks failed. OpenCode agent will be informed of existing issues." >> $GITHUB_STEP_SUMMARY
          else
            echo "should-continue=true" >> $GITHUB_OUTPUT
            echo "✅ Quality checks passed. Safe to proceed." >> $GITHUB_STEP_SUMMARY
          fi

  post-check:
    name: Post-Change Quality Check
    if: ${{ inputs.check-after && !cancelled() }}
    runs-on: ubuntu-latest
    needs: [pre-check]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install dependencies
        run: |
          cd web && npm ci
          cd ../electron && npm ci
          cd ../mobile && npm ci

      - name: Auto-fix lint issues
        if: ${{ inputs.auto-fix }}
        run: |
          echo "## Auto-Fixing Lint Issues" >> $GITHUB_STEP_SUMMARY
          make lint-fix || true

      - name: Check for auto-fix changes
        if: ${{ inputs.auto-fix }}
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No auto-fixable lint issues found." >> $GITHUB_STEP_SUMMARY
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "✅ Auto-fixed lint issues:" >> $GITHUB_STEP_SUMMARY
            echo '```diff' >> $GITHUB_STEP_SUMMARY
            git diff --stat >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

      - name: Commit auto-fixes
        if: ${{ inputs.auto-fix && steps.check-changes.outputs.changes == 'true' }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "style: auto-fix lint issues [skip ci]"
          git push

      - name: Run final quality checks
        id: final-check
        run: |
          echo "## Final Quality Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TYPECHECK_RESULT=0
          LINT_RESULT=0
          TEST_RESULT=0
          
          echo "Running TypeScript type check..." >> $GITHUB_STEP_SUMMARY
          if make typecheck 2>&1 | tee typecheck.log; then
            echo "✅ TypeScript: Passed" >> $GITHUB_STEP_SUMMARY
          else
            TYPECHECK_RESULT=1
            echo "❌ TypeScript: Failed" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>TypeScript Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 typecheck.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running ESLint..." >> $GITHUB_STEP_SUMMARY
          if make lint 2>&1 | tee lint.log; then
            echo "✅ ESLint: Passed" >> $GITHUB_STEP_SUMMARY
          else
            LINT_RESULT=1
            echo "❌ ESLint: Failed" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Lint Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 lint.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Running tests..." >> $GITHUB_STEP_SUMMARY
          if make test 2>&1 | tee test.log; then
            echo "✅ Tests: Passed" >> $GITHUB_STEP_SUMMARY
          else
            TEST_RESULT=1
            echo "❌ Tests: Failed" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>Test Failures</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -100 test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ $TYPECHECK_RESULT -ne 0 ] || [ $LINT_RESULT -ne 0 ] || [ $TEST_RESULT -ne 0 ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "❌ **Quality checks failed after changes!**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ **All quality checks passed!**" >> $GITHUB_STEP_SUMMARY
            exit 0
          fi

      - name: Post failure summary
        if: ${{ failure() && inputs.fail-on-errors }}
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## ⛔ Quality Gate Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The changes introduced quality issues. Please:" >> $GITHUB_STEP_SUMMARY
          echo "1. Review the errors above" >> $GITHUB_STEP_SUMMARY
          echo "2. Fix TypeScript errors manually" >> $GITHUB_STEP_SUMMARY
          echo "3. Run \`make lint-fix\` for auto-fixable lint issues" >> $GITHUB_STEP_SUMMARY
          echo "4. Run \`make test\` to verify tests pass" >> $GITHUB_STEP_SUMMARY
          echo "5. Re-run the workflow" >> $GITHUB_STEP_SUMMARY
