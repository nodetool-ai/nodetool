name: Hourly OpenCode Test

on:
  schedule:
    - cron: "0 */6 * * *" # Every hour

jobs:
  opencode:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches to enable merging and conflict resolution

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: web/package-lock.json

      - name: Install web dependencies
        run: |
          cd web
          npm ci

      - name: Install electron dependencies
        run: |
          cd electron
          npm ci
      
      - name: Install mobile dependencies
        run: |
          cd mobile
          npm ci

      - name: Pre-flight Quality Check
        id: pre-check
        continue-on-error: true
        run: |
          echo "## ðŸ” Pre-Flight Quality Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Checking current codebase quality before OpenCode agent runs..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TYPECHECK_EXIT=0
          LINT_EXIT=0
          TEST_EXIT=0
          
          echo "### TypeScript Type Check" >> $GITHUB_STEP_SUMMARY
          if make typecheck 2>&1 | tee typecheck-pre.log; then
            echo "âœ… No TypeScript errors" >> $GITHUB_STEP_SUMMARY
          else
            TYPECHECK_EXIT=1
            ERROR_COUNT=$(grep -c "error TS" typecheck-pre.log || echo "0")
            echo "âš ï¸ Found $ERROR_COUNT TypeScript error(s)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ESLint Check" >> $GITHUB_STEP_SUMMARY
          if make lint 2>&1 | tee lint-pre.log; then
            echo "âœ… No lint errors" >> $GITHUB_STEP_SUMMARY
          else
            LINT_EXIT=1
            ERROR_COUNT=$(grep -c "error" lint-pre.log || echo "0")
            WARNING_COUNT=$(grep -c "warning" lint-pre.log || echo "0")
            echo "âš ï¸ Found $ERROR_COUNT error(s) and $WARNING_COUNT warning(s)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suite" >> $GITHUB_STEP_SUMMARY
          if make test 2>&1 | tee test-pre.log; then
            echo "âœ… All tests passing" >> $GITHUB_STEP_SUMMARY
          else
            TEST_EXIT=1
            echo "âš ï¸ Some tests failing" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Store results for OpenCode agent
          echo "TYPECHECK_PRE_EXIT=$TYPECHECK_EXIT" >> $GITHUB_ENV
          echo "LINT_PRE_EXIT=$LINT_EXIT" >> $GITHUB_ENV
          echo "TEST_PRE_EXIT=$TEST_EXIT" >> $GITHUB_ENV
          
          if [ $TYPECHECK_EXIT -ne 0 ] || [ $LINT_EXIT -ne 0 ] || [ $TEST_EXIT -ne 0 ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âš ï¸ **Pre-existing quality issues detected.**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The OpenCode agent should focus on FIXING these issues!" >> $GITHUB_STEP_SUMMARY
            echo "- Run \`make lint-fix\` to auto-fix lint issues" >> $GITHUB_STEP_SUMMARY
            echo "- Fix TypeScript errors manually" >> $GITHUB_STEP_SUMMARY
            echo "- Debug and fix failing tests" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **Codebase quality is clean!**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run OpenCode
        uses: anomalyco/opencode/github@latest
        env:
          MINIMAX_API_KEY: ${{ secrets.MINIMAX_API_KEY }}
        with:
          model: minimax/MiniMax-M2.1
          prompt: |
            # NodeTool Quality Assurance (Scheduled Workflow)

            You are an autonomous agent ensuring code quality in NodeTool, a visual AI workflow builder.

            ## Your Mission

            **Run quality checks and fix any issues found.** Submit small, coherent PRs for each issue type.

            ## Project Context

            **NodeTool** is a React/TypeScript visual AI workflow builder.
            - **Tech Stack**: React 18.2, TypeScript 5.7, Zustand, ReactFlow, MUI v7
            - **Packages**: `/web` (React app), `/electron` (desktop), `/mobile` (React Native)
            - **Quality Tools**: TypeScript, ESLint, Jest, React Testing Library, Playwright

            ## Step 0: Check for Duplicate Work (CRITICAL!)

            **BEFORE starting any work**:
            1. **Run `git branch -a`** to see all existing branches
            2. **Check for branches** with similar test fixes or quality work
            3. **Avoid creating duplicate branches** for the same issues
            4. If a branch exists for similar work:
               - Review what's already done
               - Consider if you should continue that work
               - Don't duplicate efforts

            ## Step 1: Check Memory (REQUIRED)

            **Read these files and folders FIRST**:
            1. **`.github/opencode-memory/features.md`** - Understand what exists before testing
            2. **`.github/opencode-memory/issues/`** - List folders to see known issues by topic
               - Check `issues/testing/`, `issues/linting/`, etc. for relevant solutions
            3. `.github/opencode-memory/project-context.md` - Recent changes

            **Check if similar fixes have been attempted before!**

            ## âš ï¸ CRITICAL: Quality Guardrails (MANDATORY)

            **BEFORE YOU START**: The workflow has run pre-flight quality checks.
            - Check the "Pre-Flight Quality Check" step results above
            - Pre-existing issues: TypeCheck=$TYPECHECK_PRE_EXIT, Lint=$LINT_PRE_EXIT, Test=$TEST_PRE_EXIT
            - Exit code 0 = passing, non-zero = failing
            - **THIS IS YOUR PRIMARY MISSION: FIX THESE ISSUES!**
            
            ## Step 2: Fix Quality Issues (Your Mission)

            ### Mandatory Workflow
            
            1. **Auto-fix lint issues first**:
               ```bash
               make lint-fix  # Auto-fix many lint issues
               ```
            
            2. **Run quality checks to see what remains**:
               ```bash
               make typecheck  # See TypeScript errors
               make lint       # See remaining lint errors
               make test       # See test failures
               ```
            
            3. **Fix errors systematically**:
               - **TypeScript errors**: Fix type issues manually (see common patterns below)
               - **Lint errors**: After auto-fix, fix remaining manually
               - **Test failures**: Debug and fix failing tests
            
            4. **Verify all checks pass**:
               ```bash
               make check  # Runs all three checks - must exit 0
               ```
            
            **QUALITY GATE RULES**:
            - âœ… If codebase was clean, it MUST stay clean
            - ðŸŽ¯ If codebase had errors, you MUST fix them (that's your job!)
            - ðŸš« NEVER commit code that makes quality worse
            - ðŸ“Š The workflow will compare before/after and FAIL if quality degraded
            
            ### Step 2 (cont): Run Quality Checks

            ### Mandatory Commands

            Run these commands to find issues:

            ```bash
            # 1. Type Check (REQUIRED)
            make typecheck
            # Must exit with code 0

            # 2. Lint Check (REQUIRED)
            make lint
            # Must exit with code 0

            # 3. Run Tests (REQUIRED)
            make test
            # Must exit with code 0
            ```

            ### What Each Check Does

            **TypeScript (`make typecheck`)**:
            - Catches type errors
            - Ensures type safety
            - Validates interface usage
            - Checks for `any` types

            **ESLint (`make lint`)**:
            - Code quality rules
            - React best practices
            - Unused code detection
            - Consistent code style

            **Jest (`make test`)**:
            - Unit tests
            - Integration tests
            - Component tests
            - Regression prevention

            ## Step 3: Fix Issues Found

            ### Issue Priority

            1. **Critical**: Test failures, type errors blocking builds
            2. **High**: Lint errors, security issues
            3. **Medium**: Lint warnings, missing tests
            4. **Low**: Style inconsistencies, minor optimizations

            ### Common Issues & Solutions

            #### TypeScript Errors

            **Type Errors**:
            ```typescript
            // âŒ Error: Type 'any' is not allowed
            const data: any = fetchData();

            // âœ… Fix: Use explicit type
            interface Data {
              id: string;
              name: string;
            }
            const data: Data = fetchData();
            ```

            **Null/Undefined**:
            ```typescript
            // âŒ Error: Object is possibly 'null'
            const name = user.name;

            // âœ… Fix: Use optional chaining
            const name = user?.name;

            // Or type guard
            if (user) {
              const name = user.name;
            }
            ```

            #### ESLint Errors

            **Strict Equality**:
            ```typescript
            // âŒ Error: Expected '===' and instead saw '=='
            if (value == null) { }

            // âœ… Fix: Use strict equality
            if (value === null) { }

            // Exception: checking both null and undefined
            if (value == null) { } // OK with comment
            ```

            **Empty Catch Blocks**:
            ```typescript
            // âŒ Error: Empty block statement
            try {
              parse(data);
            } catch (e) {}

            // âœ… Fix: Add comment
            try {
              parse(data);
            } catch (e) {
              // Parse failed, continue with default
            }
            ```

            **Unused Variables**:
            ```typescript
            // âŒ Error: 'unused' is defined but never used
            const unused = fetchData();

            // âœ… Fix: Remove or use it
            // (Remove if truly unused)
            ```

            **Throwing Non-Error**:
            ```typescript
            // âŒ Error: Expected an error object to be thrown
            throw "Error message";

            // âœ… Fix: Throw Error object
            throw new Error("Error message");
            ```

            #### Test Failures

            **Async Tests**:
            ```typescript
            // âŒ Error: Test times out
            test('async operation', () => {
              expect(getData()).resolves.toBe('data');
            });

            // âœ… Fix: Make test async or return promise
            test('async operation', async () => {
              await expect(getData()).resolves.toBe('data');
            });
            ```

            **Missing Mocks**:
            ```typescript
            // âŒ Error: Cannot read property of undefined
            test('uses API', () => {
              const result = apiClient.fetch();
            });

            // âœ… Fix: Mock the API
            jest.mock('../api/client');
            test('uses API', () => {
              apiClient.fetch.mockReturnValue('data');
            });
            ```

            ### Auto-Fix Many Issues

            **Use auto-fix for common problems:**
            ```bash
            make lint-fix  # Auto-fixes many lint issues
            ```

            This handles:
            - Missing semicolons
            - Unused imports
            - Formatting issues
            - Some TypeScript issues

            ## Step 4: Verify Fixes

            **After fixing, run checks again:**
            ```bash
            make typecheck  # Must exit 0
            make lint       # Must exit 0
            make test       # Must exit 0
            ```

            **All three must pass before opening PR!**

            ## Step 5: Update Memory

            **After fixing issues**, add a new file to the appropriate issues folder:

            1. **`.github/opencode-memory/issues/<topic>/`** - Create a new file:
               - Use kebab-case naming: `your-issue-fix.md`
               - Choose the right topic folder (testing, linting, typescript, etc.)
               - Format:
               ```markdown
               # Issue Title

               **Problem**: One sentence describing what was broken

               **Solution**: One sentence explaining the fix

               **Files**: List affected files

               **Date**: YYYY-MM-DD
               ```

            2. **`.github/opencode-memory/project-context.md`** - ONLY for major test fixes (MAX 5 entries, delete oldest):
               ```markdown
               - **Fix Title (YYYY-MM-DD)**: One sentence. Files: affected-file.tsx
               ```

            **Keep it minimal** - Only write truly important information.

            ## Best Practices

            ### Submit Focused PRs

            - **One issue type per PR**: Don't mix type errors with test failures
            - **Small changes**: 5-10 files maximum per PR
            - **Clear titles**: "Fix TypeScript errors in NodeStore" not "Fix stuff"
            - **Descriptive descriptions**: What, why, how

            ### Before Opening PR

            **Checklist**:
            - [ ] All three quality checks pass (`make typecheck lint test`)
            - [ ] Changes are minimal and focused
            - [ ] Existing functionality still works
            - [ ] Memory files updated with learnings
            - [ ] PR description explains changes

            ### Common Pitfalls

            âŒ **Don't**:
            - Fix unrelated issues in the same PR
            - Break existing functionality
            - Skip quality checks
            - Ignore test failures
            - Make large refactors

            âœ… **Do**:
            - Fix one issue type at a time
            - Verify all checks pass
            - Update tests if needed
            - Document solutions in memory
            - Follow existing patterns

            ## Reference Documentation

            - **Quality requirements**: `.github/opencode-memory/build-test-lint.md` (CRITICAL!)
            - **Project docs**: `/AGENTS.md`
            - **Coding patterns**: `/.github/copilot-instructions.md`
            - **Testing guide**: `/web/TESTING.md`
            - **Makefile**: Build and test commands

            ## Individual Package Commands

            If you need to test specific packages:

            ```bash
            # Web package
            cd web
            npm run typecheck
            npm run lint
            npm run lint:fix
            npm test

            # Electron package
            cd electron
            npm run typecheck
            npm run lint
            npm run lint:fix
            npm test

            # Mobile package
            cd mobile
            npm run typecheck
            npm test
            ```

            ## Workflow Strategy

            1. **Run all checks**: `make typecheck lint test`
            2. **Identify issues**: Read error messages carefully
            3. **Check memory**: Look for known solutions
            4. **Fix one type**: Start with highest priority
            5. **Verify fix**: Re-run specific check
            6. **Run all checks**: Ensure nothing broke
            7. **Update memory**: Document solution
            8. **Open PR**: Small, focused, tested

            ## If All Checks Pass

            **Great! If all checks pass:**

            1. Document in memory that checks passed at this time
            2. Optionally improve test coverage
            3. Optionally add tests for untested features
            4. Don't make unnecessary changes

            ## Remember

            - **Quality first**: All checks must pass
            - **Be focused**: One issue type per PR
            - **Test thoroughly**: Verify fixes work
            - **Document solutions**: Update memory
            - **Learn from history**: Check memory first

            You're working autonomously. Be systematic. Fix issues methodically. Test thoroughly. Update memory!

            Now, ensure NodeTool quality is top-notch! âœ…

      - name: Post-change Quality Verification
        if: always()
        id: post-check
        run: |
          echo "## ðŸ” Post-Change Quality Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Verifying quality after OpenCode agent completed..." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          TYPECHECK_EXIT=0
          LINT_EXIT=0
          TEST_EXIT=0
          
          echo "### TypeScript Type Check" >> $GITHUB_STEP_SUMMARY
          if make typecheck 2>&1 | tee typecheck-post.log; then
            echo "âœ… No TypeScript errors" >> $GITHUB_STEP_SUMMARY
          else
            TYPECHECK_EXIT=1
            ERROR_COUNT=$(grep -c "error TS" typecheck-post.log || echo "0")
            echo "âŒ Found $ERROR_COUNT TypeScript error(s)" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 typecheck-post.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ESLint Check" >> $GITHUB_STEP_SUMMARY
          if make lint 2>&1 | tee lint-post.log; then
            echo "âœ… No lint errors" >> $GITHUB_STEP_SUMMARY
          else
            LINT_EXIT=1
            ERROR_COUNT=$(grep -c "error" lint-post.log || echo "0")
            WARNING_COUNT=$(grep -c "warning" lint-post.log || echo "0")
            echo "âŒ Found $ERROR_COUNT error(s) and $WARNING_COUNT warning(s)" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View Errors</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 lint-post.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Suite" >> $GITHUB_STEP_SUMMARY
          if make test 2>&1 | tee test-post.log; then
            echo "âœ… All tests passing" >> $GITHUB_STEP_SUMMARY
          else
            TEST_EXIT=1
            echo "âŒ Some tests failing" >> $GITHUB_STEP_SUMMARY
            echo "<details><summary>View Failures</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            tail -50 test-post.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Compare with pre-check
          QUALITY_DEGRADED=false
          QUALITY_IMPROVED=false
          
          if [ "$TYPECHECK_PRE_EXIT" -eq 0 ] && [ $TYPECHECK_EXIT -ne 0 ]; then
            echo "ðŸ”´ **NEW TypeScript errors introduced!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_DEGRADED=true
          elif [ "$TYPECHECK_PRE_EXIT" -ne 0 ] && [ $TYPECHECK_EXIT -eq 0 ]; then
            echo "ðŸŽ‰ **TypeScript errors FIXED!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_IMPROVED=true
          fi
          
          if [ "$LINT_PRE_EXIT" -eq 0 ] && [ $LINT_EXIT -ne 0 ]; then
            echo "ðŸ”´ **NEW lint errors introduced!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_DEGRADED=true
          elif [ "$LINT_PRE_EXIT" -ne 0 ] && [ $LINT_EXIT -eq 0 ]; then
            echo "ðŸŽ‰ **Lint errors FIXED!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_IMPROVED=true
          fi
          
          if [ "$TEST_PRE_EXIT" -eq 0 ] && [ $TEST_EXIT -ne 0 ]; then
            echo "ðŸ”´ **NEW test failures introduced!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_DEGRADED=true
          elif [ "$TEST_PRE_EXIT" -ne 0 ] && [ $TEST_EXIT -eq 0 ]; then
            echo "ðŸŽ‰ **Test failures FIXED!**" >> $GITHUB_STEP_SUMMARY
            QUALITY_IMPROVED=true
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$QUALITY_DEGRADED" = true ]; then
            echo "âŒ **QUALITY GATE FAILED: Code quality degraded!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "The changes introduced NEW quality issues." >> $GITHUB_STEP_SUMMARY
            echo "Please fix these issues before merging." >> $GITHUB_STEP_SUMMARY
            exit 1
          elif [ $TYPECHECK_EXIT -ne 0 ] || [ $LINT_EXIT -ne 0 ] || [ $TEST_EXIT -ne 0 ]; then
            if [ "$QUALITY_IMPROVED" = true ]; then
              echo "âœ… **Quality improved but issues remain**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "Good progress! Continue fixing remaining issues." >> $GITHUB_STEP_SUMMARY
            else
              echo "âš ï¸ **Quality issues remain (but no new ones)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "No new errors introduced, but pre-existing issues weren't fixed." >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âœ… **ALL QUALITY CHECKS PASSED!**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            if [ "$QUALITY_IMPROVED" = true ]; then
              echo "ðŸŽ‰ Excellent work! Quality issues were fixed!" >> $GITHUB_STEP_SUMMARY
            else
              echo "Code quality maintained at excellent level." >> $GITHUB_STEP_SUMMARY
            fi
          fi
